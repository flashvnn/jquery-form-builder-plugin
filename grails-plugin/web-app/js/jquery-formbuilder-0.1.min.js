/*
* jquery-form-builder-plugin - JQuery WYSIWYG Web Form Builder
* http://code.google.com/p/jquery-form-builder-plugin/
*
* Revision: 27
* Version: 0.1
* Copyright 2011 Lim Chee Kin (limcheekin@vobject.com)
*
* Licensed under Apache v2.0 http://www.apache.org/licenses/LICENSE-2.0.html
*
* Date: Fri Jan 14 19:55:09 GMT+08:00 2011
*/
var FormBuilder={options:{widgets:["PlainText"],tabSelected:0,_builderForm:"#builderForm fieldset",_emptyBuilderPanel:"#emptyBuilderPanel",_standardFieldsPanel:"#standardFields",_fancyFieldsPanel:"#fancyFields",_fieldSettingsLanguageSection:"#fieldSettings fieldset.language:first",_fieldSettingsGeneralSection:"#fieldSettings div.general:first",_formSettingsLanguageSection:"#formSettings fieldset.language:first",_formSettingsGeneralSection:"#formSettings div.general:first"},_create:function(){this._log("FormBuilder._create called. this.options.widgets = "+
this.options.widgets);this._initBuilderPalette();this._initBuilderPanel()},_initBuilderPalette:function(){$(window).scroll(function(){if($(window).scrollTop()>$(".floatingPanelIdentifier").position({scroll:false}).top){$(".floatingPanel").css("position","fixed");$(".floatingPanel").css("top","0")}if($(window).scrollTop()<=$(".floatingPanelIdentifier").position({scroll:false}).top){$(".floatingPanel").css("position","relative");$(".floatingPanel").css("top",$(".floatingPanelIdentifier").position)}});
$("#paletteTabs").tabs({selected:this.options.tabSelected});var a=this.options.widgets,c=a.length,d,e,b;for(b=0;b<c;b++){d=$.fb["fb"+a[b]].prototype.options;e=$('<a id="'+d.type+'" href="#" class="fbWidget">'+d.name+"</a>")["fb"+d.type]();e.button().appendTo(d.belongsTo)}},_initBuilderPanel:function(){this._initFormSettings();this._initSortableWidgets();this._initWidgetsEventBinder()},_initFormSettings:function(){var a=$(this.options._builderForm),c=$("#name",a),d=$("#description",a);a=$(this.options._formSettingsGeneralSection);
$("input[id$='form.name']",a).val(c.val()).change(function(e){c.val($(e.target).val())});$("[id$='form.description']",a).val(d.val()).change(function(e){d.val($(e.target).val())})},_initWidgetsEventBinder:function(){var a=$("#builderForm div.ctrlHolder"),c=["name","settings","sequence"];if(a.size()>0){var d,e;$(this.options._emptyBuilderPanel+":visible").hide();a.each(function(b){d=$(this);e=d.find("input[id$='fields["+b+"].type']").val();d.click($.fb["fb"+e].prototype.getFieldSettings);for(var f=
0;f<c.length;f++)d.find("input[id$='fields["+b+"]."+c[f]+"']").change($.fb.fbWidget.prototype._updateStatus)});a.find(".closeButton").click($.fb.fbWidget.prototype._deleteWidget)}},_initSortableWidgets:function(){var a=$(this.options._builderForm);a.sortable({axis:"y",cursor:"move",helper:function(c,d){return $(d).clone().css({opacity:0.6,border:"3px solid #cccccc"})},start:function(c,d){var e=$(d.item).prev();if(e.attr("rel")){d.item.prevIndex=e.attr("rel");d.item.originalPositionTop=e.position().top}},
update:function(c,d){var e=$(d.item),b;b=d.position.top>d.item.originalPositionTop;$.fb.formbuilder.prototype._log("moveDown = "+b+", ui.position.top = "+d.position.top+", ui.item.originalPositionTop = "+d.item.originalPositionTop);if(d.item.prevIndex){var f='[rel="'+d.item.prevIndex+'"]';if(b){b=e.prevUntil(f);$.fb.formbuilder.prototype._moveDown(e,b)}else{$.fb.formbuilder.prototype._getSequence(e).val($.fb.formbuilder.prototype._getSequence(e.next()).val()).change();b=e.nextUntil(f);b.each(function(){$.fb.formbuilder.prototype._increaseSequence($(this))});
$.fb.formbuilder.prototype._increaseSequence($(f))}}else{b=e.prevAll();$.fb.formbuilder.prototype._moveDown(e,b)}}});a.disableSelection()},_init:function(){this._log("FormBuilder._init called.");this.method1("calling from FormBuilder._init")},destroy:function(){this._log("FormBuilder.destroy called.");$.Widget.prototype.destroy.call(this)},_log:function(a){window.console&&window.console.log&&window.console.log(a)},_moveDown:function(a,c){$.fb.formbuilder.prototype._getSequence(a).val($.fb.formbuilder.prototype._getSequence(a.prev()).val()).change();
c.each(function(){$.fb.formbuilder.prototype._decreaseSequence($(this))})},_getSequence:function(a){return a.find("input[id$='fields["+a.attr("rel")+"].sequence']")},_increaseSequence:function(a){if(a.is(":visible")){a=$.fb.formbuilder.prototype._getSequence(a);a.val(a.val()*1+1);a.change()}},_decreaseSequence:function(a){if(a.is(":visible")){a=$.fb.formbuilder.prototype._getSequence(a);a.val(a.val()-1);a.change()}},method1:function(a){this._log("FormBuilder.method1 called. params = "+a)}};
$.widget("fb.formbuilder",FormBuilder);
var FbWidget={options:{option1:"FbWidget.optionValue",_styleClass:"ctrlHolder"},_log:function(a){window.console&&window.console.log&&window.console.log(a)},_create:function(){this._log("FbWidget._create called. this.options.option1 = "+this.options.option1);this.element.click(this.createWidget)},_init:function(){this._log("FbWidget._init called.")},destroy:function(){this._log("FbWidget.destroy called.");this.element.button("destroy");$.Widget.prototype.destroy.call(this)},createField:function(a,
c,d,e){var b=$.fb.formbuilder.prototype.options,f=$("#builderForm div.ctrlHolder").size();$('<a class="ui-corner-all closeButton" href="#"><span class="ui-icon ui-icon-close">delete this widget</span></a>').prependTo(c).click($.fb.fbWidget.prototype._deleteWidget);c.attr("rel",f);c.append($.fb.fbWidget.prototype._createFieldProperties(a,d,e,f));$(b._emptyBuilderPanel+":visible").hide();$(b._builderForm).append(c).sortable("refresh")},propertyName:function(a){a=a.replace(/ /gi,"");return a=a.charAt(0).toLowerCase()+
a.substring(1)},_deleteWidget:function(a){var c=$(a.target).parent().parent(),d=c.attr("rel");if(c.find("input[id$='fields["+d+"].id']").val()=="null")c.remove();else{c.find("input[id$='fields["+d+"].status']").val("D");c.hide()}a.stopPropagation()},_createFieldProperties:function(a,c,d,e){var b="fields["+e+"].";a=$('<div class="fieldProperties"> \t\t<input type="hidden" id="'+b+'id" name="'+b+'id" value="null" /> \t\t<input type="hidden" id="'+b+'name" name="'+b+'name" value="'+a+'" /> \t\t<input type="hidden" id="'+
b+'type" name="'+b+'type" value="'+c.type+'" /> \t\t<input type="hidden" id="'+b+'settings" name="'+b+'settings" /> \t\t<input type="hidden" id="'+b+'sequence" name="'+b+'sequence" value="'+e+'" /> \t\t<input type="hidden" id="'+b+'status" name="'+b+'status" /> \t\t</div>');a.find("input[id$='"+b+"settings']").val($.toJSON(d));return a},_updateStatus:function(a){$widget=$(a.target);$.fb.fbWidget.prototype._log($widget.attr("id")+" updated");if($widget.parent().find("input:first").val()!="null"){$.fb.fbWidget.prototype._log("status updated");
$widget.parent().find("input:last").val("U")}},createWidget:function(){alert("createWidget(event) should be overriden by subclass")}};$.widget("fb.fbWidget",FbWidget);
var FbPlainText=$.extend({},$.fb.fbWidget.prototype,{options:{type:"PlainText",name:"Plain Text",html:'<div class="ctrlHolder"><div class="PlainText"></div></div>',belongsTo:$.fb.formbuilder.prototype.options._fancyFieldsPanel,settings:{en:{text:"Plain Text Value",classes:["leftAlign","topAlign"]},zh:{text:"\u7121\u683c\u5f0f\u6587\u5b57",classes:["rightAlign","topAlign"]},styles:{fontFamily:"default",color:"default",backgroundColor:"default"}}},_create:function(){$.fb.fbWidget.prototype._create.call(this);
this._log("FbPlainText._create called. this.options.text = "+this.options.settings.en.text)},_init:function(){$.fb.fbWidget.prototype._init.call(this);this._log("FbPlainText._init called.")},destroy:function(){this._log("FbPlainText.destroy called.");$.fb.fbWidget.prototype.destroy.call(this)},createWidget:function(a){a=$(a.target).parent().data("fbPlainText");var c=$("div."+a.options.type).size()+1,d=a.propertyName(a.options.type+c),e=$("#language").val();c=a.options.settings[e].text+" "+c;var b=
$(a.options.html).addClass(a.options.settings[e].classes[1]).click(a.getFieldSettings),f=jQuery.extend(true,{},a.options.settings);f[e].text=c;b.find("div.PlainText").text(c).addClass(f[e].classes[0]);a.createField(d,b,a.options,f)},getFieldSettings:function(a){a=$(a.target);var c=a.attr("class").indexOf($.fb.fbWidget.prototype.options._styleClass)>-1?a:a.parent();a=$.fb.formbuilder.prototype.options;var d=c.attr("rel"),e=c.find("input[id$='fields["+d+"].settings']");$.fb.fbWidget.prototype._log("settings = "+
e.val());$.fb.fbWidget.prototype._log("unescaped settings = "+unescape(e.val()));var b=$.parseJSON(unescape(e.val()));$.fb.fbWidget.prototype._log("PlainText.getFieldSettings. id = "+c.attr("id")+", "+c.attr("rel"));var f=$('<div class="clear labelOnTop"> \t\t<label for="text">Text (?)</label><br /> \t\t<input type="text" id="text" /> \t</div> \t<div class="2cols"> \t\t<div class="labelOnTop col1 noPaddingBottom"> \t\t\t<label for="horizontalAlignment">Horizontal Align (?)</label><br /> \t\t\t<select id="horizontalAlignment"> \t\t\t\t<option value="leftAlign">left</option> \t\t\t\t<option value="centerAlign">center</option> \t\t\t\t<option value="rightAlign">right</option> \t\t\t</select> \t\t</div> \t\t<div class="labelOnTop col2"> \t\t<label for="verticalAlignment">Vertical Align (?)</label><br /> \t\t\t<select id="verticalAlignment"> \t\t\t\t<option value="topAlign">top</option> \t\t\t\t<option value="middleAlign">middle</option> \t\t\t\t<option value="bottomAlign">bottom</option> \t\t\t</select> \t  </div> \t</div>'),
i=$(a._fieldSettingsLanguageSection),j=$("#language"),h=j.val();$("legend",i).text("Language: "+j.find("option:selected").text());$.fb.fbWidget.prototype._log("language = "+h+", "+j.find("option:selected").text());f.find("input#text").val(c.find("div.PlainText").text()).change(function(g){g=$(g.target).val();c.find("div.PlainText").text(g);b[h].text=g;e.val($.toJSON(b)).change()});f.find("select#horizontalAlignment").val(b[h].classes[0]).change(function(g){var k=c.find("div.PlainText");g=$(g.target).val();
k.removeClass(b[h].classes[0]).addClass(g);b[h].classes[0]=g;e.val($.toJSON(b)).change()});f.find("select#verticalAlignment").val(b[h].classes[1]).change(function(g){c.find("div.PlainText");g=$(g.target).val();c.removeClass(b[h].classes[1]).addClass(g);b[h].classes[1]=g;e.val($.toJSON(b)).change()});i.children(":not(legend)").remove();i.append(f);f=$('<div class="2cols"> \t\t<div class="labelOnTop col1 noPaddingBottom"> \t\t\t<label for="name">Name (?)</label><br/> \t\t  <input type="text" id="name" /> \t\t</div> \t</div>');
f.find("input#name").val(c.find("input[id$='fields["+d+"].name']").val()).change(function(g){c.find("input[id$='fields["+d+"].name']").val($(g.target).val()).change()});a=$(a._fieldSettingsGeneralSection);a.children().remove();a.append(f);$("#paletteTabs").tabs("select",1)}});$.widget("fb.fbPlainText",FbPlainText);
