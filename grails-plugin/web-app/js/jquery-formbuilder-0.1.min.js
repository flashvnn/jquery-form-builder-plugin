/*
* jquery-form-builder-plugin - JQuery WYSIWYG Web Form Builder
* http://code.google.com/p/jquery-form-builder-plugin/
*
* Revision: 33
* Version: 0.1
* Copyright 2011 Lim Chee Kin (limcheekin@vobject.com)
*
* Licensed under Apache v2.0 http://www.apache.org/licenses/LICENSE-2.0.html
*
* Date: Sun Jan 16 22:56:17 GMT+08:00 2011 
*/
var FormBuilder={options:{widgets:["PlainText"],tabSelected:0,readOnly:false,tabDisabled:[],_builderForm:"#builderForm fieldset",_emptyBuilderPanel:"#emptyBuilderPanel",_standardFieldsPanel:"#standardFields",_fancyFieldsPanel:"#fancyFields",_fieldSettingsPanel:"#fieldSettings",_fieldSettingsLanguageSection:"#fieldSettings fieldset.language:first",_fieldSettingsGeneralSection:"#fieldSettings div.general:first",_formSettingsLanguageSection:"#formSettings fieldset.language:first",_formSettingsGeneralSection:"#formSettings div.general:first"},
_create:function(){this._log("FormBuilder._create called. this.options.widgets = "+this.options.widgets);this._initBuilderPalette();this._initBuilderPanel()},_initBuilderPalette:function(){$(window).scroll(function(){if($(window).scrollTop()>$(".floatingPanelIdentifier").position({scroll:false}).top){$(".floatingPanel").css("position","fixed");$(".floatingPanel").css("top","0")}if($(window).scrollTop()<=$(".floatingPanelIdentifier").position({scroll:false}).top){$(".floatingPanel").css("position",
"relative");$(".floatingPanel").css("top",$(".floatingPanelIdentifier").position)}});$("#paletteTabs").tabs({selected:this.options.tabSelected,disabled:this.options.tabDisabled});var a=this.options.widgets,c=a.length,b,e,d;for(d=0;d<c;d++){b=$.fb["fb"+a[d]].prototype.options;e=$('<a id="'+b._type+'" href="#" class="fbWidget">'+b.name+"</a>");e.button()["fb"+b._type]({fbOptions:this.options}).appendTo(b.belongsTo)}},_initBuilderPanel:function(){if(this.options.readOnly){$("input:not(div.buttons input)").attr("disabled",
true);$("select").attr("disabled",true);$("textarea").attr("disabled",true)}else{this._initFormSettings();this._initSortableWidgets()}this._initWidgetsEventBinder()},_initFormSettings:function(){var a=$(this.options._builderForm),c=$("#name",a),b=$("#description",a);a=$(this.options._formSettingsGeneralSection);$("input[id$='form.name']",a).val(c.val()).change(function(e){c.val($(e.target).val())});$("[id$='form.description']",a).val(b.val()).change(function(e){b.val($(e.target).val())})},_initWidgetsEventBinder:function(){var a=
$("."+$.fb.fbWidget.prototype.options._styleClass);if(a.size()>0){var c,b,e=["name","settings","sequence"];$(this.options._emptyBuilderPanel+":visible").hide();a.each(function(d){c=$(this);b=c.find("input[id$='fields["+d+"].type']").val();c.click($.fb["fb"+b].prototype._createFieldSettings);for(var f=0;f<e.length;f++)c.find("input[id$='fields["+d+"]."+e[f]+"']").change($.fb.fbWidget.prototype._updateStatus)});this.options.readOnly||a.find(".closeButton").click($.fb.fbWidget.prototype._deleteWidget)}},
_initSortableWidgets:function(){var a=$(this.options._builderForm);a.sortable({axis:"y",cursor:"move",helper:function(c,b){return $(b).clone().css({opacity:0.6,border:"3px solid #cccccc"})},start:function(c,b){var e=$(b.item).prev();if(e.attr("rel")){b.item.prevIndex=e.attr("rel");b.item.originalPositionTop=e.position().top}},update:function(c,b){var e=$(b.item),d;d=b.position.top>b.item.originalPositionTop;$.fb.formbuilder.prototype._log("moveDown = "+d+", ui.position.top = "+b.position.top+", ui.item.originalPositionTop = "+
b.item.originalPositionTop);if(b.item.prevIndex){var f='[rel="'+b.item.prevIndex+'"]';if(d){d=e.prevUntil(f);$.fb.formbuilder.prototype._moveDown(e,d)}else{$.fb.formbuilder.prototype._getSequence(e).val($.fb.formbuilder.prototype._getSequence(e.next()).val()).change();d=e.nextUntil(f);d.each(function(){$.fb.formbuilder.prototype._increaseSequence($(this))});$.fb.formbuilder.prototype._increaseSequence($(f))}}else{d=e.prevAll();$.fb.formbuilder.prototype._moveDown(e,d)}}});a.disableSelection()},_init:function(){this._log("FormBuilder._init called.");
this.method1("calling from FormBuilder._init")},destroy:function(){this._log("FormBuilder.destroy called.");$.Widget.prototype.destroy.call(this)},_log:function(a){window.console&&window.console.log&&window.console.log(a)},_moveDown:function(a,c){$.fb.formbuilder.prototype._getSequence(a).val($.fb.formbuilder.prototype._getSequence(a.prev()).val()).change();c.each(function(){$.fb.formbuilder.prototype._decreaseSequence($(this))})},_getSequence:function(a){return a.find("input[id$='fields["+a.attr("rel")+
"].sequence']")},_increaseSequence:function(a){if(a.is(":visible")){a=$.fb.formbuilder.prototype._getSequence(a);a.val(a.val()*1+1);a.change()}},_decreaseSequence:function(a){if(a.is(":visible")){a=$.fb.formbuilder.prototype._getSequence(a);a.val(a.val()-1);a.change()}},method1:function(a){this._log("FormBuilder.method1 called. params = "+a)}};$.widget("fb.formbuilder",FormBuilder);
var FbWidget={options:{fbOptions:"",_styleClass:"ctrlHolder"},_log:function(a){window.console&&window.console.log&&window.console.log(a)},_create:function(){this._log("FbWidget._create called.")},_init:function(){this._log("FbWidget._init called.");this.element.click(this._createFbWidget)},destroy:function(){this._log("FbWidget.destroy called.");this.element.button("destroy");$.Widget.prototype.destroy.call(this)},_createField:function(a,c,b,e){var d=$.fb.formbuilder.prototype.options,f=$("#builderForm div.ctrlHolder").size();
$('<a class="ui-corner-all closeButton" href="#"><span class="ui-icon ui-icon-close">delete this widget</span></a>').prependTo(c).click($.fb.fbWidget.prototype._deleteWidget);c.attr("rel",f);c.append($.fb.fbWidget.prototype._createFieldProperties(a,b,e,f));$(d._emptyBuilderPanel+":visible").hide();$(d._builderForm).append(c).sortable("refresh")},propertyName:function(a){a=a.replace(/ /gi,"");return a=a.charAt(0).toLowerCase()+a.substring(1)},_deleteWidget:function(a){var c=$(a.target).parent().parent(),
b=c.attr("rel");if(c.find("input[id$='fields["+b+"].id']").val()=="null")c.remove();else{c.find("input[id$='fields["+b+"].status']").val("D");c.hide()}a.stopPropagation()},_createFieldProperties:function(a,c,b,e){var d="fields["+e+"].";a=$('<div class="fieldProperties"> \t\t<input type="hidden" id="'+d+'id" name="'+d+'id" value="null" /> \t\t<input type="hidden" id="'+d+'name" name="'+d+'name" value="'+a+'" /> \t\t<input type="hidden" id="'+d+'type" name="'+d+'type" value="'+c._type+'" /> \t\t<input type="hidden" id="'+
d+'settings" name="'+d+'settings" /> \t\t<input type="hidden" id="'+d+'sequence" name="'+d+'sequence" value="'+e+'" /> \t\t<input type="hidden" id="'+d+'status" name="'+d+'status" /> \t\t</div>');a.find("input[id$='"+d+"settings']").val($.toJSON(b));return a},_updateStatus:function(a){$widget=$(a.target);$.fb.fbWidget.prototype._log($widget.attr("id")+" updated");if($widget.parent().find("input:first").val()!="null"){$.fb.fbWidget.prototype._log("field status updated");$widget.parent().find("input:last").val("U")}},
_createFbWidget:function(){$.fb.fbWidget.prototype._log("_createFbWidget executing");var a="fb"+$(this).fbWidget("option","_type");$.fb.fbWidget.prototype._log("type = "+a);a=$(this).data(a);for(var c=jQuery.extend(true,{},a.options.settings),b=a.getCounter(a),e=a.options._languages,d=0;d<e.length;d++){c[e[d]][a.options._counterField]+=" "+b;a._log(c[e[d]][a.options._counterField])}e=$('<div class="'+a.options._styleClass+'"></div>');a._log("b4. text = "+c[$("#language").val()].text);d=a.getWidget(a,
c[$("#language").val()],e);a._log("at. text = "+c[$("#language").val()].text);b=a.propertyName(a.options._type+b);d.click(a._createFieldSettings);e.append(d);a._createField(b,e,a.options,c);a._log("_createFbWidget executed")},_createFieldSettings:function(){$.fb.fbWidget.prototype._log("_createFieldSettings executing.");var a=$(this);a=a.attr("class").indexOf($.fb.fbWidget.prototype.options._styleClass)>-1?a:a.parent();var c=a.find("input[id$='fields["+a.attr("rel")+"].type']").val();$.fb.fbWidget.prototype._log("type = "+
c);$this=$("#"+c).data("fb"+c);c=$this.options.fbOptions;$this._log("$widget.text() = "+a.text()+", formbuilderOptions.readOnly = "+c.readOnly);var b=a.find("input[id$='fields["+a.attr("rel")+"].settings']");$this._log("settings = "+b.val());$this._log("unescaped settings = "+unescape(b.val()));var e=$.parseJSON(unescape(b.val()));a.data("fbWidget",e);var d=$(c._fieldSettingsLanguageSection),f=$("#language");$("legend",d).text("Language: "+f.find("option:selected").text());b=$this.getFieldSettingsLanguageSection($this,
a,e[f.val()]);d.children(":not(legend)").remove();for(var g=0;g<b.length;g++)d.append(b[g]);b=$this.getFieldSettingsGeneralSection($this,a,e[f.val()]);$this._log("fieldSettings.length = "+b.length);a=$(c._fieldSettingsGeneralSection);a.children().remove();for(g=0;g<b.length;g++){$this._log(b[g].html());a.append(b[g])}if(c.readOnly){a=$(c._fieldSettingsPanel);$("input",a).attr("disabled",true);$("select",a).attr("disabled",true);$("textarea",a).attr("disabled",true)}$("#paletteTabs").tabs("select",
1);$.fb.fbWidget.prototype._log("_createFieldSettings executed.")},updateSettings:function(a,c){var b=a.data("fbWidget"),e=a.find("input[id$='fields["+a.attr("rel")+"].settings']");b[$("#language").val()]=c;e.val($.toJSON(b)).change()},twoColumns:function(a,c){var b=$('<div class="2cols"> \t\t<div class="labelOnTop col1 noPaddingBottom"></div> \t  <div class="labelOnTop col2"></div>     </div>');b.find(".col1").append(a);b.find(".col2").append(c);return b},oneColumn:function(a){return $('<div class="clear labelOnTop"></div>').append(a)},
horizontalAlignment:function(){return $('<label for="field.horizontalAlignment">Horizontal Align (?)</label><br /> \t\t<select id="field.horizontalAlignment"> \t\t\t<option value="leftAlign">left</option> \t\t\t<option value="centerAlign">center</option> \t\t\t<option value="rightAlign">right</option> \t\t</select>')},verticalAlignment:function(){return $('<label for="field.verticalAlignment">Vertical Align (?)</label><br /> \t\t\t<select id="field.verticalAlignment"> \t\t\t\t<option value="topAlign">top</option> \t\t\t\t<option value="middleAlign">middle</option> \t\t\t\t<option value="bottomAlign">bottom</option> \t\t\t</select>')},
name:function(a){var c=a.attr("rel"),b=$('<label for="field.name">Name (?)</label><br/>  \t\t\t\t  <input type="text" id="field.name" />');b.val(a.find("input[id$='fields["+c+"].name']").val()).change(function(e){a.find("input[id$='fields["+c+"].name']").val($(e.target).val()).change()});return b},getWidget:function(){$.fb.fbWidget.prototype._log("getWidget($this, settings, ctrlHolder) should be overriden by subclass.")},getFieldSettingsLanguageSection:function(){$.fb.fbWidget.prototype._log("getFieldSettingsLanguageSection($this, $widget, settings) should be overriden by subclass.")},
getFieldSettingsGeneralSection:function(){$.fb.fbWidget.prototype._log("getFieldSettingsLanguageSection($this, $widget, settings) should be overriden by subclass.")}};$.widget("fb.fbWidget",FbWidget);
var FbPlainText=$.extend({},$.fb.fbWidget.prototype,{options:{name:"Plain Text",belongsTo:$.fb.formbuilder.prototype.options._fancyFieldsPanel,_type:"PlainText",_html:'<div class="PlainText"></div>',_counterField:"text",_languages:["en","zh"],settings:{en:{text:"Plain Text Value",classes:["leftAlign","topAlign"]},zh:{text:"\u7121\u683c\u5f0f\u6587\u5b57",classes:["rightAlign","topAlign"]},styles:{fontFamily:"default",color:"default",backgroundColor:"default"}}},_create:function(){$.fb.fbWidget.prototype._create.call(this);
this.options=$.extend({},$.fb.fbWidget.prototype.options,this.options);this._log("FbPlainText._create called. this.options.text = "+this.options.settings.en.text);this._log("FbPlainText._create called. this.options.option1 = "+this.options.option1)},_init:function(){$.fb.fbWidget.prototype._init.call(this);this._log("FbPlainText._init called.")},destroy:function(){this._log("FbPlainText.destroy called.");$.fb.fbWidget.prototype.destroy.call(this)},getWidget:function(a,c,b){b.addClass(c.classes[1]);
return $(a.options._html).text(c.text).addClass(c.classes[0])},getCounter:function(a){return $("div."+a.options._type).size()+1},getFieldSettingsLanguageSection:function(a,c,b){var e=$('<label for="field.text">Text (?)</label><br /> \t                 <input type="text" id="field.text" />').val(c.find("div.PlainText").text()).change(function(){var g=$(this).val();c.find("div.PlainText").text(g);b.text=g;a.updateSettings(c,b)}),d=a.verticalAlignment().val(b.classes[1]).change(function(){var g=$(this).val();
c.removeClass(b.classes[1]).addClass(g);b.classes[1]=g;a.updateSettings(c,b)}),f=a.horizontalAlignment().val(b.classes[0]).change(function(){var g=c.find("div.PlainText"),h=$(this).val();g.removeClass(b.classes[0]).addClass(h);b.classes[0]=h;a.updateSettings(c,b)});return[a.oneColumn(e),a.twoColumns(d,f)]},getFieldSettingsGeneralSection:function(a,c){return[a.oneColumn(a.name(c))]}});$.widget("fb.fbPlainText",FbPlainText);
